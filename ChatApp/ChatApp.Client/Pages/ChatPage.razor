@page "/chat/{userName}"
@using ChatApp.Client.Pages.Components
@using Microsoft.AspNetCore.SignalR.Client
@using Shared.Models
@rendermode InteractiveWebAssembly
@inject NavigationManager Navigation
<PageTitle>Chat</PageTitle>

<div class="chat-page">
    <div class="chat-list">
        <ChatListComponent SelectUser="@ChangeChat" Chats="@chats" UserName="@userName"></ChatListComponent>
    </div>

    <div class="chat-window">
        @if (currentChat != null && currentChat.Messages.Any())
        {
            @foreach (var message in currentChat.Messages)
            {
                <div class="message">
                    <div class="message-header">
                        <div class="message-body">
                            <span class="message-time">@message.TimeSent.ToString("HH:mm")</span>
                            <span>@message.SenderName</span>
                            <p>@message.Body</p>
                        </div>
                    </div>
                </div>
            }
        }
    </div>

    <div class="message-input-area">
        <input type="text" class="message-input" @bind-value="newMessage.Body" @onkeyup="HandleKeyPress" placeholder="Type your message..." />
        <button class="send-button" @onclick="SendMessageAsync">Send</button>
    </div>
</div>

@code {
    private Message newMessage = new();
    private User currentUser = new();
    private Chat currentChat = new();
    private List<Chat> chats = new();
    private HubConnection hubConnection;
    private HttpClient httpClient;
    [Parameter]
    public string userName { get; set; }
    private string receiverName;

    protected override async Task OnInitializedAsync()
    {
        httpClient = new HttpClient { BaseAddress = new Uri("https://localhost:7121") };

        await InitializeHubConnectionAsync();
        await LoadUserDataAsync();
        await RegisterUserAsync();
    }

    private async Task InitializeHubConnectionAsync()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/chathub"))
            .Build();

        hubConnection.On<Message>("ReceiveMessage", async (message) => await HandleReceivedMessageAsync(message));

        await hubConnection.StartAsync();
    }

    private async Task LoadUserDataAsync()
    {
        currentUser = await httpClient.GetFromJsonAsync<User>($"api/user?username={userName}");
        if (currentUser?.Chats != null)
        {
            chats = await httpClient.GetFromJsonAsync<List<Chat>>($"api/user/GetUserChats?username={userName}");
            currentChat = currentUser.Chats.FirstOrDefault();
        }
        currentUser.UserName = userName;
    }

    private async Task RegisterUserAsync()
    {
        await hubConnection.InvokeAsync("Register", userName);
        StateHasChanged();
    }

    private async Task HandleReceivedMessageAsync(Message message)
    {
        var targetChat = chats.FirstOrDefault(x => x.Id == message.ChatId);

        if (targetChat == null)
        {
            targetChat = new Chat { Id = message.ChatId, Sender = new User { UserName = message.SenderName }, UnreadMessages = 1 };
            chats.Add(targetChat);
        }
        else if (currentChat == null || message.ChatId != currentChat.Id)
        {
            targetChat.UnreadMessages++;
        }
        else
        {
            currentChat.Messages.Add(message);
        }

        await UpdateChatAsync(targetChat);
        await InvokeAsync(StateHasChanged);
    }

    private async Task UpdateChatAsync(Chat chat)
    {
        if (chat != null)
        {
            await httpClient.PostAsJsonAsync($"/api/user/UpdateChat", chat);
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendMessageAsync();
        }
    }

    private async Task SendMessageAsync()
    {
        if (currentChat == null || string.IsNullOrWhiteSpace(newMessage.Body))
        {
            return;
        }

        newMessage.ChatId = currentChat.Id;
        newMessage.TimeSent = DateTime.Now;
        newMessage.SenderName = currentUser.UserName;
        currentChat.Messages.Add(newMessage);

        await hubConnection.InvokeAsync("SendMessage", newMessage, receiverName);
        newMessage = new Message();
    }

    private async Task ChangeChat(string newReceiverName)
    {
        receiverName = newReceiverName;
        currentChat = await GetOrCreateChatAsync(userName, receiverName);

        if (!chats.Any(x => x.Id == currentChat.Id))
        {
            chats.Add(currentChat);
        }

        StateHasChanged();
    }

    private async Task<Chat> GetOrCreateChatAsync(string senderName, string receiverName)
    {
        return await httpClient.GetFromJsonAsync<Chat>($"/api/user/GetOrCreateChat?senderName={senderName}&receiverName={receiverName}");
    }
}
